<!DOCTYPE html PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html>
  <head>
    <title>Wage Gap</title>
    <script src="../node_modules/scrollama/build/scrollama.js"></script>
    <link href="css/interactive-style.css" rel="stylesheet" />
  </head>
  <body>
    <section id="intro">
      <div>
        <h1><span class="female">Wage</span> <span class="male">Gap</span></h1>
        <h2>
          How your salary fits within the wage gap <br />
          between males and females in the US
        </h2>
        <h3>Project by Libby Seline</h3>
      </div>
    </section>
    <section id="scrolly">
      <article>
        <div
          class="step"
          data-step="1"
          style="padding: 0px 0px"
          data-scrollama-index="0"
          id="begin"
        >
          <div class="step-text">
            <p><span id="intro_paragraph"></span></p>
            <ul>
              <li>
                a
                <span class="user_race"></span>
                <span class="user_sex"></span>
              </li>
              <li>
                who lives in
                <span class="user_metro"></span> metro area
              </li>
              <li>
                and works in
                <span class="user_industry"></span>.
              </li>
            </ul>
            <p>
              Your income is
              <span class="user_income"></span>. How does that compare with
              other <span class="user_sex"></span>s?
            </p>
          </div>
        </div>

        <div
          class="step"
          data-step="1"
          style="padding: 145px 0px"
          data-scrollama-index="1"
        >
          <div class="step-text">
            <p>STEP 1</p>
          </div>
          <div class="step-graph" id="graph1"></div>
        </div>
        <div
          class="step"
          data-step="2"
          style="padding: 286px 0px"
          data-scrollama-index="2"
        >
          <div class="step-text">
            <p>STEP 2</p>
          </div>
          <div class="step-graph" id="graph2"></div>
        </div>
        <div
          class="step"
          data-step="3"
          style="padding: 201px 0px"
          data-scrollama-index="3"
        >
          <div class="step-text">
            <p>STEP 3</p>
          </div>
          <div class="step-graph" id="graph3"></div>
        </div>
        <div
          class="step"
          data-step="4"
          style="padding: 130px 0px"
          data-scrollama-index="4"
        >
          <div class="step-text">
            <p>STEP 4</p>
          </div>
          <div class="step-graph" id="graph4"></div>
        </div>
      </article>
    </section>
  </body>
  <script type="module">
    // AI Disclaimer: learned how to read in d3 from AI/Google Response
    import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
    import { main } from "../generateGraphs.js";

    // PART 1: Read in form

    // AI Disclaimer: I used AI to learn how to accept the form responses \
    // (defining queryString, urlParams, userReport)
    const queryString = window.location.search;
    console.log(queryString);
    const urlParams = new URLSearchParams(queryString);
    console.log(urlParams);

    const user_name = urlParams.get("name");
    const user_income = urlParams.get("income");
    const user_sex = urlParams.get("sex_dd");
    const user_industry = urlParams.get("industry_dd");
    const user_race = urlParams.get("race_dd");
    const user_metro = urlParams.get("metro_dd");
    const sex_lower = user_sex.toLocaleLowerCase();
    console.log(sex_lower);

    // Part 2: HTML based on form variables
    // AI Disclaimer: Learned how to call a string in HTML with Gemini
    // Further asked about calling classes

    const formatMoney = d3.format("$,.0f"); // Formula created with AI
    if (user_name) {
      d3.selectAll(".user_name").text(`${user_name}`);
    }
    if (user_income) {
      d3.selectAll(".user_income").text(`${formatMoney(+user_income)}`);
    }
    if (user_sex) {
      d3.selectAll(".user_sex").text(`${user_sex}`);
    }
    if (user_industry) {
      d3.selectAll(".user_industry").text(`${user_industry}`);
    }
    if (user_race) {
      d3.selectAll(".user_race").text(`${user_race}`);
    }
    if (user_metro) {
      d3.selectAll(".user_metro").text(`${user_metro}`);
    }
    console.log(user_name === "Average Female in US");
    if (user_name === "Average Female in US") {
      d3.select("#intro_paragraph").text(`For this simulation, you are`);
    } else {
      d3.select("#intro_paragraph").text(
        `Hey ${user_name}. Let's recap what you entered in the form. You are `
      );
    }
    const data = await d3.json(
      "https://raw.githubusercontent.com/libbyseline/WageGap-Frontend/refs/heads/main/data/quants_avg_by_race_23_all_copy.json"
    );
    console.log(data);

    // Part 3: Data Prep
    let step1_data = data.filter(
      (d) => d.sex === sex_lower && d.race_ethnc_gen === "All"
    );
    let step2_data = data.filter((d) => d.race_ethnc_gen === "All");
    let step3_data = data.filter(
      (d) => d.sex === sex_lower && d.race_ethnc_gen != "All"
    );
    let step4_data = data.filter((d) => d.race_ethnc_gen != "All");

    console.log(step1_data);
    console.log(step2_data);
    console.log(step3_data);
    console.log(step4_data);

    // Part 4: Graph features
    // AI Disclaimer: Used AI to figure out how I should calculate the width -- and thus container, margin, and height
    const container = d3.select(".step-graph");
    const margin = { top: 20, right: 20, bottom: 40, left: 50 };
    const width =
      container.node().getBoundingClientRect().width -
      margin.left -
      margin.right;
    const height =
      container.node().getBoundingClientRect().height -
      margin.top -
      margin.bottom;
    const shp_size_1 = height / (2 * step1_data.length);

    // Part 5: Make graphs, append to div
    const chart1 = main(
      "#graph1",
      step1_data,
      user_income,
      margin,
      width,
      height,
      shp_size_1
    );
    const chart2 = main(
      "#graph2",
      step2_data,
      user_income,
      margin,
      width,
      height,
      shp_size_1
    );

    // COPY/PASTE DISCLAIMER:
    // The base for Scrollytelly elements are from Scrollama's basic template: https://russellsamora.github.io/scrollama/basic/

    var scrolly = document.querySelector("#scrolly");
    var article = scrolly.querySelector("article");
    var step = article.querySelectorAll(".step");

    // initialize the scrollama
    var scroller = scrollama();

    // scrollama event handlers
    function handleStepEnter(response) {
      // response = { element, direction, index }
      console.log(response);
      // add to color to current step
      response.element.classList.add("is-active");
    }

    function handleStepExit(response) {
      // response = { element, direction, index }
      console.log(response);
      // remove color from current step
      response.element.classList.remove("is-active");
    }

    function init() {
      // set random padding for different step heights (not required)
      //   step.forEach(function (step) {
      //     var v = 100 + Math.floor((Math.random() * window.innerHeight) / 4);
      //     step.style.padding = v + "px 0px";
      //   });

      // 1. setup the scroller with the bare-bones options
      // 		this will also initialize trigger observations
      // 2. bind scrollama event handlers (this can be chained like below)
      scroller
        .setup({
          step: "#scrolly article .step",
          debug: false,
          offset: 0.5,
        })
        .onStepEnter(handleStepEnter)
        .onStepExit(handleStepExit);
    }

    // kick things off
    init();
  </script>
</html>
